# 编译选项与构建工具速览

## 目录

1. [GCC/G++ 常用编译选项](#gccg-常用编译选项)
2. [构建工具生态图谱](#构建工具生态图谱)
3. [常见组合与实践示例](#常见组合与实践示例)
4. [快速选择建议](#快速选择建议)
5. [参考与扩展阅读](#参考与扩展阅读)

---

## GCC/G++ 常用编译选项

### 1.1 语言与流程控制

| 选项 | 作用 | 备注 |
|------|------|------|
| `-c` | 仅编译生成目标文件 (`.o`) | 不进入链接阶段 |
| `-S` | 仅生成汇编代码 (`.s`) | 常用于调试或分析 |
| `-E` | 仅执行预处理 | 打印宏展开后的结果 |
| `-std=c++17` | 指定语言标准 | `c++11`/`c11` 等均可 |
| `-pedantic` | 按标准严格检查 | 非标准特性会警告 |

### 1.2 优化选项

| 选项 | 作用 | 适用场景 |
|------|------|----------|
| `-O0` | 不优化，保留调试信息 | 默认值，调试友好 |
| `-O1` | 基础优化 | 快速构建 |
| `-O2` | 常用优化级别 | Release 默认 |
| `-O3` | 激进优化 | 数值/科学计算 |
| `-Ofast` | 放宽标准的优化 | 需确认与标准兼容性 |
| `-Os` | 体积优化 | 嵌入式、体积敏感 |
| `-march=native` | 启用当前 CPU 特性 | 同一机器部署 |
| `-flto` | 链接时优化 (LTO) | 需编译与链接都加 |

### 1.3 调试与诊断

| 选项 | 功能 |
|------|------|
| `-g` / `-g3` / `-ggdb` | 生成不同粒度的调试符号 |
| `-fno-omit-frame-pointer` | 保留栈帧指针，便于栈回溯 |
| `-fsanitize=address` | AddressSanitizer，检测越界、UAF |
| `-fsanitize=undefined` | 检测未定义行为 |
| `-fsanitize=leak` | 内存泄漏检测 |
| `-pg` | 生成 gprof 性能分析信息 |

### 1.4 警告控制

| 选项 | 描述 |
|------|------|
| `-Wall` | 启用大部分常见警告 |
| `-Wextra` | 启用额外警告 |
| `-Werror` | 将警告视为错误 |
| `-Wshadow` | 检测变量遮蔽 |
| `-Wconversion` | 类型转换可能丢失信息时警告 |
| `-Wno-unused-parameter` | 关闭未使用参数警告 |

### 1.5 链接与库相关

| 选项 | 描述 |
|------|------|
| `-L<path>` | 新增库搜索路径 |
| `-l<name>` | 链接指定库（如 `-lpthread`）|
| `-static` / `-shared` | 生成静态/共享目标 |
| `-fPIC` | 构建位置无关代码（共享库必备）|
| `-Wl,<option>` | 向链接器传递参数（如 `-Wl,-rpath`）|

### 1.6 预处理与宏

| 选项 | 描述 |
|------|------|
| `-DNAME` / `-DNAME=value` | 定义宏 |
| `-Uname` | 取消宏 |
| `-I<path>` | 添加头文件搜索路径 |
| `-MMD -MP` | 生成依赖信息，便于增量编译 |

### 1.7 GCC 与 G++ 的差异小结

- **默认语言判定**：`gcc` 按扩展区分 (`.c` → C)，`g++` 默认按 C++ 处理。
- **标准库链接**：`g++` 自动链接 `libstdc++`，`gcc` 需显式 `-lstdc++`。
- **宏与语法检查**：`g++` 会自动开启 C++ 相关宏与语法规则。

### 1.8 在 CMake 中引入编译选项

```cmake
# 针对特定目标追加编译选项
target_compile_options(myapp PRIVATE
    -Wall -Wextra -Werror
    $<$<CONFIG:Release>:-O3 -DNDEBUG>
)

# 链接阶段选项
target_link_options(myapp PRIVATE
    $<$<CONFIG:Release>:-flto>
)
```

---

## 构建工具生态图谱

```text
源码 + CMakeLists/Meson.build
          │
          ▼
  构建系统生成器 (CMake/Meson)
          │ 输出 Makefile、build.ninja、IDE 工程
          ▼
  构建执行器 (make/ninja/msbuild)
          │ 调用编译器、链接器
          ▼
  gcc/g++/clang + ld → 可执行文件/库
```

### 2.1 工具类型总览

| 工具 | 分类 | 主要职责 | 典型输出/输入 |
|------|------|----------|---------------|
| gcc / g++ | 编译器驱动 | 将源代码转换为目标文件、可执行文件 | 输入源码，输出 `.o`/bin |
| make | 构建执行器 | 解析 `Makefile`，执行命令 | 需要现成 `Makefile` |
| ninja | 构建执行器 | 高效执行 `build.ninja` 中的任务图 | 需生成 `build.ninja` |
| cmake | 构建系统生成器 | 将 `CMakeLists.txt` 转换为 Makefile/Ninja/IDE 工程 | 输出给 make/ninja/MSBuild |
| meson | 构建系统生成器 | 解析 `meson.build`，默认生成 Ninja 构建文件 | 配套 `meson compile`/`ninja` |

### 2.2 工具之间的关系

- **CMake → Make/Ninja**：CMake 本身不编译代码，只生成构建脚本，随后由 `make` 或 `ninja` 执行这些脚本调用 gcc/g++。
- **Meson → Ninja**：Meson 默认生成 Ninja 构建描述，也可以输出 VS/Xcode 工程。
- **make ↔ 手写 Makefile**：传统项目可能直接编写 `Makefile`，无需 CMake。
- **编译器驱动互换**：在 CMake/Meson 中可以切换为 Clang、ICC 等编译器。

### 2.3 典型特性对比

| 维度 | make | ninja | cmake | meson |
|------|------|-------|-------|-------|
| 配置语言 | Makefile | build.ninja | CMake DSL | DSL + Python 风格 |
| 增量构建速度 | 中 | 非常快 | 依赖后端 | 依赖 Ninja |
| 跨平台支持 | 需手写 | 需生成 | 强 | 强 |
| IDE 集成 | 有限 | 有限 | 可生成 VS/Xcode 工程 | 通过生成后端 |
| 学习曲线 | 中等 | 简单 | 中等（现代用法） | 清晰但需新 DSL |
| 常用场景 | 传统项目、内核 | Chrome/LLVM 等大型项目 | 主流 C/C++ 项目 | 现代跨平台/嵌入式 |

---

## 常见组合与实践示例

### 3.1 CMake + GCC (默认)

```bash
cmake -S . -B build \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_CXX_COMPILER=g++
cmake --build build -j$(nproc)
```

### 3.2 CMake + Ninja + Clang

```bash
cmake -S . -B build-ninja \
  -G Ninja \
  -DCMAKE_C_COMPILER=clang \
  -DCMAKE_CXX_COMPILER=clang++
cmake --build build-ninja
```

### 3.3 Meson + Ninja

```bash
meson setup builddir --buildtype=debugoptimized
meson compile -C builddir        # 等价于 ninja -C builddir
meson test -C builddir           # 运行测试
```

### 3.4 手写 Makefile + gcc/g++

```make
CC = gcc
CXX = g++
CFLAGS = -Wall -O2

app: main.o util.o
    $(CXX) $^ -o $@

%.o: %.c
    $(CC) $(CFLAGS) -c $< -o $@
```

---

## 快速选择建议

1. **已有 CMake 项目**：直接使用 `cmake` 生成构建系统，执行 `cmake --build`；需要加速时切换 Ninja。
2. **需要更现代的配置语言**：尝试 Meson，默认配套 Ninja，语法更简洁。
3. **小型实验或作业**：手写 `Makefile` + `gcc/g++` 即可。
4. **调试与发布双配置**：使用 CMake/Meson 的 `Debug`、`Release` 预设，配合 `-g`、`-O3`、`-DNDEBUG` 等选项。
5. **性能敏感项目**：结合 `-O3`、`-march=native`、`-flto`，并使用 Ninja 提升构建速度。

---

## 参考与扩展阅读

- GCC 官方手册: <https://gcc.gnu.org/onlinedocs/gcc/Option-Summary.html>
- CMake 官方文档: <https://cmake.org/cmake/help/latest/>
- Meson 构建系统: <https://mesonbuild.com/>
- Ninja 文档: <https://ninja-build.org/manual.html>
